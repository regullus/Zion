@model PagedList.IPagedList<Core.Entities.Usuario>
@using PagedList.Mvc;
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var traducaoHelper = (Core.Helpers.TraducaoHelper)ViewBag.TraducaoHelper;
    var associacoes = (IEnumerable<Core.Entities.Associacao>)ViewBag.Associacoes;
    var classificacoes = (IEnumerable<Core.Entities.Classificacao>)ViewBag.Classificacoes;
    var produtos = (IEnumerable<Core.Entities.Produto>)ViewBag.Produtos;
    var meioPagamentos = (IEnumerable<Core.Entities.MeioPagamento>)ViewBag.MeioPAgamento;
    var usuarioEntraOutraAba = ViewBag.UsuarioEntraOutraAba;
}
@section pageStyles {
    @Styles.Render("~/Content/sweetAlert")
}
@section head {}
@section pageScripts {
    <script>
      //$(document).on("click", ".openAtivar", function () {
      //   var persistIDUsusario = $(this).data('id');
      //   $('#impIDUsuario').attr('value', persistIDUsusario);
      //});

      $(".openAtivar").on("click", function () {
         var persistIDUsusario = $(this).data('id');
         $('#impIDUsuario').attr('value', persistIDUsusario);
      });

      $(".openAlterarSenha").on("click", function () {
         var id = $(this).data('id');
          $('#UsuarioIDAlterarSenha').attr('value', id);

          $("#NovaSenha").val('');
          $("#token2F").val('');

          $(".altera-senha-hide").show();
          $(".msg-altera-senha").text('');
          $("#modal-body-form").show();
          $("#modal-body-footer").show();
          $("#alterar-senha-loader").hide();

          $("#alterarSenha").modal('show');
      });

      $(".ConfirmarAlterarSenha").on("click", function () {

           var id = $('#UsuarioIDAlterarSenha').val();
           var senha = $("#NovaSenha").val();
           var token2F = $("#token2F").val();

           if (senha) {

                $("#alterar-senha-loader").show();
                $(".msg-altera-senha").text('');

               $.post('@Url.Action("AlterarSenha", "Usuarios")', { id: id, senha: senha, token2F: token2F }, function (data) {

                    $("#alterar-senha-loader").hide();

                   if (data.OK) {
                       $(".altera-senha-hide").hide();
                   }

                   $(".msg-altera-senha").text(data.msg);
               });

           }

       });

      $(".cbo").change(function () {
         var persistIDUsusario = $('#impIDUsuario').val();
         $('#impIDUsuario').attr('value', persistIDUsusario);
      });

      $('.ConfirmarAtivar').on('click', function () {
         var persistIDUsusario = $('#impIDUsuario').val();
         $('#impIDUsuario').attr('value', persistIDUsusario);

         swal({
            title: '@Html.Raw(traducaoHelper["TEM_CERTEZA"])',
            text: '@Html.Raw(traducaoHelper["DESEJA_ATIVAR_USUARIO"])',
            type: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '@Html.Raw(traducaoHelper["SIM"])',
            cancelButtonText: '@Html.Raw(traducaoHelper["NAO"])',
            closeOnConfirm: false,
            closeOnCancel: false
         },
         function (isConfirm) {
            if (isConfirm) {
               var skuProdutoAdesao = $("#cboProduto").val();
               var meioPagamento = $('#cboPagamento').val();
               var paraAvaliacao = 0;
               if ($('#paraAvaliacao').prop('checked')) {
                  paraAvaliacao = 1;
               };

               $.ajax({
                  url: '@Url.Action("Ativar")',
                  type: 'POST',
                  data: { 'UsuAtivarID': persistIDUsusario, 'skuProdutoAdesao': skuProdutoAdesao, 'meioPagamento': meioPagamento, 'paraAvaliacao': paraAvaliacao },
                  success: function (data) {
                     if (data == 'OK') {
                        $('[name=' + persistIDUsusario + ']').hide();
                        swal('@Html.Raw(traducaoHelper["SUCESSO"])', '@Html.Raw(traducaoHelper["USUARIO_ATIVADO_SUCESSO"])', 'success');
                     }
                     else {
                        swal('@Html.Raw(traducaoHelper["ERRO"])', data, 'error');
                     }
                  },
                  error: function (data) {
                     swal('@Html.Raw(traducaoHelper["ERRO"])', data, 'error');
                  }
               });

            } else {
               swal('@Html.Raw(traducaoHelper["CANCELADO"])', '@Html.Raw(traducaoHelper["SOLICITACAO_CANCELADA"])', 'error');
            };
         });

      });

      function Logar(usuarioID) {
         $.post('@Url.Action("Logar", "Usuarios")', { id: usuarioID }, function (data) {
            if (data != 'Index') {
               window.open(data);
            }
            else{
               Redirect(data);
            }
         });
      }

    </script>
}

@section PageLevelScripts{
    @Scripts.Render("~/scripts/sweetAlert")
}

@section jQueryRead {}

<div class="portlet box grey-gallery">
    <div class="portlet-title">
        <div class="caption"><i class="fa fa-reorder"></i> @traducaoHelper["USUARIOS"]</div>
        <div class="tools">
            <a href="javascript:;" class="collapse" title="@traducaoHelper["FECHAR"]" />
            <a href='@Url.Action("Reload", "Usuarios")' class="atualizar" title="@traducaoHelper["RELER"]" />
        </div>
        <div class="actions">
            <a href='@Url.Action("Excel", "Usuarios", new { CurrentProcuraLogin = ViewBag.CurrentProcuraLogin, CurrentProcuraPatrocinador = ViewBag.CurrentProcuraPatrocinador} )' class="btn btn-sm yellow-casablanca">
                <i class="fa fa-file-excel-o"></i> Excel
            </a>
            <label>&nbsp;</label>
        </div>
    </div>

    <div class="portlet-body">
        <div class="table-toolbar">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <div class="input-group">
                            @using (Html.BeginForm("Index", "Usuarios", FormMethod.Get))
                            {
                                @Html.DropDownList("NumeroPaginas", null, htmlAttributes: new { @class = "form-control input-small input-inline marginB05" })
                                <input class="btn purple form-control input-small input-inline fontPlaceHolderIcon" id="Atualizar" name="Atualizar" value="&#xf021; @traducaoHelper["ATUALIZAR"]" type="submit" />
                            }
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    @using (Html.BeginForm("Index", "Usuarios", FormMethod.Get))
                    {
                        <div class="form-group pull-right">
                            <div class="input-group">
                                @Html.TextBox("ProcuraLogin", ViewBag.CurrentProcuraLogin as string, new { @class = "form-control input-small input-inline fontPlaceHolderIcon marginB05", @placeholder = traducaoHelper["LOGIN_NOME_EMAIL"] })
                                @Html.TextBox("ProcuraPatrocinador", ViewBag.CurrentProcuraPatrocinador as string, new { @class = "form-control input-small input-inline fontPlaceHolderIcon marginB05", @placeholder = traducaoHelper["PATROCINADOR"] })
                                <input class="btn blue-madison form-control input-small input-inline fontPlaceHolderIcon" id="Procura" name="Procura" value="&#xf002; @traducaoHelper["PROCURAR"]" type="submit" />
                            </div>
                        </div>
                    }
                </div>
            </div>
            <div class="row">
                <div class="col-md-10">
                    @Html.PagedListPager(Model, page => Url.Action("Index", new { page, SortOrder = ViewBag.CurrentSort, CurrentProcuraLogin = ViewBag.CurrentProcuraLogin, CurrentProcuraPatrocinador = ViewBag.CurrentProcuraPatrocinador, NumeroPaginas = ViewBag.CurrentNumeroPaginas, PageSize = ViewBag.PageSize }))
                </div>
                <div class="col-md-2">
                    <label class="pull-right">@traducaoHelper["PAG"] @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) @traducaoHelper["DE"] @Model.PageCount &nbsp;</label>
                </div>
            </div>
        </div>

        <div class="table-scrollable">
            <table class="table table-striped table-bordered table-hover">
                <thead>
                    <tr>
                        <th scope="col" style="min-width:95px; width:95px;">&nbsp;@traducaoHelper["ACOES"]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
                        <th scope="col">
                            @Html.ActionLink(traducaoHelper["LOGIN"], "Index", new { SortOrder = ViewBag.FirstSortParm, CurrentProcuraLogin = ViewBag.CurrentProcuraLogin, CurrentProcuraPatrocinador = ViewBag.CurrentProcuraPatrocinador, NumeroPaginas = ViewBag.CurrentNumeroPaginas, PageSize = ViewBag.PageSize })
                            @switch ((string)ViewBag.CurrentSort.ToString())
                            {
                                case "login":
                                    {<i class="fa fa-chevron-down"></i>}
                                    break;
                                case "login_desc":
                                    {<i class="fa fa-chevron-up"></i>}
                                    break;
                            }
                        </th>
                        <th scope="col">@traducaoHelper["NOME"]</th>
                        <th scope="col">@traducaoHelper["EMAIL"]</th>
                        <th scope="col">
                            @Html.ActionLink(@traducaoHelper["PATROCINADOR"], "Index", new { SortOrder = ViewBag.FirstSortParm, CurrentProcuraLogin = ViewBag.CurrentProcuraLogin, CurrentProcuraPatrocinador = ViewBag.CurrentProcuraPatrocinador, NumeroPaginas = ViewBag.CurrentNumeroPaginas, PageSize = ViewBag.PageSize })
                            @switch ((string)ViewBag.CurrentSort.ToString())
                            {
                                case "patrocinador":
                                    {<i class="fa fa-chevron-down"></i>}
                                    break;
                                case "patrocinador_desc":
                                    {<i class="fa fa-chevron-up"></i>}
                                    break;
                            }
                        </th>
                        <th scope="col">@traducaoHelper["ASSOCIACAO"]</th>
                        <th scope="col">@traducaoHelper["CLASSIFICACAO"]</th>
                        <th scope="col">@traducaoHelper["STATUS"]</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th scope="col" style="min-width:80px; width:80px;">&nbsp;@traducaoHelper["ACOES"]&nbsp;</th>
                        <th scope="col">
                            @Html.ActionLink(traducaoHelper["LOGIN"], "Index", new { SortOrder = ViewBag.FirstSortParm, CurrentProcuraLogin = ViewBag.CurrentProcuraLogin, CurrentProcuraPatrocinador = ViewBag.CurrentProcuraPatrocinador, NumeroPaginas = ViewBag.CurrentNumeroPaginas, PageSize = ViewBag.PageSize })
                            @switch ((string)ViewBag.CurrentSort.ToString())
                            {
                                case "login":
                                    {<i class="fa fa-chevron-down"></i>}
                                    break;
                                case "login_desc":
                                    {<i class="fa fa-chevron-up"></i>}
                                    break;
                            }
                        </th>
                        <th scope="col">@traducaoHelper["NOME"]</th>
                        <th scope="col">@traducaoHelper["EMAIL"]</th>
                        <th scope="col">
                            @Html.ActionLink(@traducaoHelper["PATROCINADOR"], "Index", new { SortOrder = ViewBag.FirstSortParm, CurrentProcuraLogin = ViewBag.CurrentProcuraLogin, CurrentProcuraPatrocinador = ViewBag.CurrentProcuraPatrocinador, NumeroPaginas = ViewBag.CurrentNumeroPaginas, PageSize = ViewBag.PageSize })
                            @switch ((string)ViewBag.CurrentSort.ToString())
                            {
                                case "patrocinador":
                                    {<i class="fa fa-chevron-down"></i>}
                                    break;
                                case "patrocinador_desc":
                                    {<i class="fa fa-chevron-up"></i>}
                                    break;
                            }
                        </th>
                        <th scope="col">@traducaoHelper["ASSOCIACAO"]</th>
                        <th scope="col">@traducaoHelper["CLASSIFICACAO"]</th>
                        <th scope="col">@traducaoHelper["STATUS"]</th>
                    </tr>
                </tfoot>
                <tbody>
                    @foreach (var item in Model)
                    {
                        var associacao = associacoes.FirstOrDefault(a => a.Nivel == item.NivelAssociacao);
                        var classificacao = classificacoes.FirstOrDefault(c => c.Nivel == item.NivelClassificacao);

                        <tr>
                            <td>
                                @Html.ActionLink("Edit", "Edit", new { id = item.ID }, new { @class = "gridEdit", title = traducaoHelper["EDITAR"] })
                                @Html.ActionLink("Details", "Details", new { id = item.ID }, new { @class = "gridDetail", title = traducaoHelper["DETALHES"] })
                                @if (User.IsInRole("perfilMaster") || User.IsInRole("perfilAdministrador"))
                                {
                                    if (usuarioEntraOutraAba)
                                    {
                                        @Html.ActionLink("Entrar", "Entrar", new { id = item.ID }, new { target = "_blank", @class = "gridTrocar", title = traducaoHelper["ENTRAR_COM_LOGIN_USUARIO"] + item.Nome })
                                        @*<a class="gridTrocar" data-toggle="modal" title="@(traducaoHelper["ENTRAR_COM_LOGIN_USUARIO"] + item.Nome)" onclick="Logar(@item.ID);"> @traducaoHelper["ENTRAR"]  </a>*@
                                    }
                                    else
                                    {
                                        @Html.ActionLink("Entrar", "Entrar", new { id = item.ID }, new { @class = "gridTrocar", title = traducaoHelper["ENTRAR_COM_LOGIN_USUARIO"] + item.Nome })
                                    }

                                    if (Core.Helpers.ConfiguracaoHelper.GetBoolean("ADM_TROCA_SENHA_RESETAR"))
                                    {
                                        @Html.ActionLink("Senha", "Senha", new { id = item.ID }, new { @class = "gridLock", title = traducaoHelper["TROCAR_ENVIAR_SENHA"] })
                                    }
                                    else
                                    {
                                        <a class="gridLock openAlterarSenha" name="@item.ID" id="@item.ID" data-id="@item.ID" data-toggle="modal" title=@traducaoHelper["ALTERAR_SENHA"] href="#altearSenha">@traducaoHelper["ALTERAR_SENHA"] </a>
                                    }
                                }


                                @if (item.Autenticacao.TwoFactorEnabled) //Verifica se usuario possui autenticação dois fatores
                                {
                                    @Html.ActionLink("DesabilitaAutenticacao", "DesabilitaAutenticacao", new { id = item.ID }, new { @class = "gridAutenticacao", title = traducaoHelper["DESABILITA_GOOGLE_AUTH"] })
                                }

                                @if (String.IsNullOrEmpty(item.Assinatura)) //Caso Usuario Não tenha sido atvado
                                {
                                    <a class="gridAtivar openAtivar" name="@item.ID" id="@item.ID" data-id="@item.ID" data-toggle="modal" title=@traducaoHelper["ATIVAR"] href="#ativar">@traducaoHelper["ATIVAR"] </a>
                                    @*<a class="btn btn-circle btn-sm green-seagreen openAtivar" name="@item.ID" id="@item.ID" data-id="@item.ID" data-toggle="modal" href="#ativar">@traducaoHelper["ATIVAR"]</a>*@
                                }
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.Login)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.Nome)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.Email)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.PatrocinadorDireto.Nome)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => associacao.Nome)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => classificacao.Nome)
                            </td>
                            <td>
                                @if (item.Bloqueado)
                                {
                                    @traducaoHelper["BLOQUEADO"]
                                }
                                else
                                {
                                    @Html.DisplayFor(modelItem => item.Status)
                                }
                            </td>

                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="row">
            <div class="border-gridFooter">
                <div class="col-md-10">
                    @Html.PagedListPager(Model, page => Url.Action("Index", new { page, SortOrder = ViewBag.CurrentSort, CurrentProcuraLogin = ViewBag.CurrentProcuraLogin, CurrentProcuraPatrocinador = ViewBag.CurrentProcuraPatrocinador, NumeroPaginas = ViewBag.CurrentNumeroPaginas, PageSize = ViewBag.PageSize }))
                </div>
                <div class="col-md-2">
                    <label class="pull-right">@traducaoHelper["PAG"]  @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) @traducaoHelper["DE"]  @Model.PageCount &nbsp;</label>
                </div>
            </div>
        </div>

    </div>

</div>

<div id="ativar" class="modal fade openAtivar" tabindex="-1" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">

        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">@traducaoHelper["ATIVAR"]</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" name="impIDUsuario" id="impIDUsuario" />
                <div class="form-group">
                    <label>@traducaoHelper["PRODUTO"]</label>
                    <select class="form-control cbo" name="cboProduto" id="cboProduto">
                        @foreach (var produto in produtos)
                        {
                            <option value="@produto.SKU">@produto.Nome</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>@traducaoHelper["MEIO_PAGAMENTO"]</label>
                    <select class="form-control cbo" name="cboPagamento" id="cboPagamento">
                        @foreach (var meioPagamento in meioPagamentos)
                        {
                            <option value="@meioPagamento.ID">@meioPagamento.Descricao</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label></label>
                    <div class="mt-checkbox-list">
                        <label class="mt-checkbox">
                            @traducaoHelper["AVALIACAO"]
                            <input type="checkbox" value="0" name="paraAvaliacao" id="paraAvaliacao" class="cbo" />
                            <span></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" data-dismiss="modal" data-id="0" class="btn btn-circle btn-sm green-seagreen ConfirmarAtivar">@Html.Raw(traducaoHelper["ATIVAR"])</button>
            </div>
        </div>
    </div>
</div>

<div id="alterarSenha" class="modal fade" tabindex="-1" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">@traducaoHelper["ALTERAR_SENHA"]</h4>
            </div>
            <div class="modal-body">
                <label class="msg-altera-senha"></label>
            </div>
            <div id="modal-body-form" class="modal-body altera-senha-hide">
                <input type="hidden" name="UsuarioIDAlterarSenha" id="UsuarioIDAlterarSenha" />
                <div class="form-group">
                    <label>Digite a nova senha</label>
                    <input type="text" id="NovaSenha" class="form-control" name="Nova Senha" />
                    <label class="msg-altera-senha"></label>
                </div>
                @if (Core.Helpers.ConfiguracaoHelper.GetString("AUTENTICACAO_DOIS_FATORES") == "true")
                {
                    <div class="form-group">
                        <img src="~/Content/global/img/google-authenticator.jpg" width="20" style="margin-bottom: 3px; margin-right: 5px;" />Token Google Authenticator<br />
                        <input type="text" class="form-control" name="token2F" id="token2F">
                        <a id="validaToken2FADinheiro" style="display:none; color: red;"></a>
                    </div>
                }

            </div>
            <div id="modal-body-footer" class="modal-footer altera-senha-hide">
                <div class="row">
                    <div class="col-md-6">
                        <img src="~/Content/global/img/ajax-loading.gif" id="alterar-senha-loader" />
                    </div>
                    <div class="col-md-6">
                        <button type="button" data-id="0" class="btn btn-circle btn-sm green-seagreen ConfirmarAlterarSenha">@Html.Raw(traducaoHelper["ALTERAR"])</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>