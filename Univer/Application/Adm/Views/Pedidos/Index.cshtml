@model PagedList.IPagedList<Core.Entities.Pedido>
@using PagedList.Mvc;
@{
    #region Layout
    Layout = "~/Views/Shared/_Layout.cshtml";
    #endregion

    #region ViewBags
    var traducaoHelper = (Core.Helpers.TraducaoHelper)ViewBag.TraducaoHelper;

    ViewBag.Title = traducaoHelper["PEDIDOS"];
    #endregion

    #region Variaveis

    var moedaPadrao = Core.Helpers.ConfiguracaoHelper.GetMoedaPadrao();

    #endregion
}

@section pageStyles {
}

@section head {
}

@section pageScripts {
    <script type="text/javascript">

        function OpcoesAtivacao(id) {
            $('#OpcoesAtivacao').modal('show');
            $('#pedidoID').val(id);
        }

        function ConfirmarPagamento(id) {
            $('#Confirmacao').modal('show');
            $('#pedidoID').val(id);
        }

        function ConfirmacaoGratuito(id) {
            $('#ConfirmacaoGratuito').modal('show');
            $('#pedidoID').val(id);
        }

        function ConfirmarCancelamento(id) {
            $('#Cancelamento').modal('show');
            $('#pedidoID').val(id);
        }

        function Lideranca() {
            var id = $('#pedidoID').val()
            $.ajax({
                url: 'Lideranca/' + id,
                type: "GET"
            })
            $('#OpcoesAtivacao').modal('hide');
            location.reload();
        }

        function Pagamento() {
            var id = $('#pedidoID').val()
            $.ajax({
                url: 'Pagar/' + id,
                type: "GET"
            })
            $('#Confirmacao').modal('hide');
            location.reload();
        }

        function Gratuito() {
            var id = $('#pedidoID').val()
            $.ajax({
                url: 'Gratuito/' + id,
                type: "GET"
            })
            $('#Confirmacao').modal('hide');
            location.reload();
        }

        function Cancelamento() {
            var id = $('#pedidoID').val()
            $.ajax({
                url: 'Cancelar/' + id,
                type: "GET"
            })
            $('#Cancelamento').modal('hide');
            location.reload();
        }
    </script>
}

@section PageLevelScripts {
}

@section jQueryRead {
}

<div class="portlet box grey-gallery">

    <input type="hidden" name="pedidoID" id="pedidoID" />
    <div class="portlet-title">
        <div class="caption"><i class="fa fa-reorder"></i> @traducaoHelper["PEDIDOS"]</div>
        <div class="tools">
            <a href="javascript:;" class="collapse" title="@traducaoHelper["FECHAR"]" />
            <a href='@Url.Action("Reload", "pedidos")' class="atualizar" title="@traducaoHelper["RELER"]" />
        </div>
        <div class="actions">
            <a href='@Url.Action("Excel", "pedidos", new { CurrentProcuraLogin = ViewBag.CurrentProcuraLogin} )' class="btn btn-sm yellow-casablanca">
                <i class="fa fa-file-excel-o"></i> Excel
            </a>
            <label>&nbsp;</label>
        </div>
    </div>

    <div class="portlet-body">

        <div class="table-toolbar">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <div class="input-group">
                            @using (Html.BeginForm("Index", "pedidos", FormMethod.Get))
                            {
                                @Html.DropDownList("NumeroPaginas", null, htmlAttributes: new { @class = "form-control input-small input-inline marginB05" })
                                <input class="btn purple form-control input-small input-inline fontPlaceHolderIcon" id="Atualizar" name="Atualizar" value="&#xf021; @traducaoHelper["ATUALIZAR"]" type="submit" />
                            }
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    @using (Html.BeginForm("Index", "pedidos", FormMethod.Get))
                    {
                        <div class="form-group pull-right">
                            <div class="input-group">
                                @Html.TextBox("ProcuraLogin", ViewBag.CurrentProcuraLogin as string, new { @class = "form-control input-small input-inline fontPlaceHolderIcon marginB05", @placeholder = traducaoHelper["LOGIN"] })
                                @Html.TextBox("ProcuraBoleto", ViewBag.CurrentProcuraBoleto as string, new { @class = "form-control input-small input-inline fontPlaceHolderIcon marginB05", @maxlength = 11, @placeholder = traducaoHelper["NUMERO_BOLETO"] })
                                <input class="btn blue-madison form-control input-small input-inline fontPlaceHolderIcon" id="Procura" name="Procura" value="&#xf002; @traducaoHelper["PROCURAR"]" type="submit" />
                            </div>
                        </div>
                    }
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="col-md-10">
                            @Html.PagedListPager(Model, page => Url.Action("Index", new { page, SortOrder = ViewBag.CurrentSort, CurrentProcuraLogin = ViewBag.CurrentProcuraLogin, NumeroPaginas = ViewBag.CurrentNumeroPaginas, PageSize = ViewBag.PageSize }))
                        </div>
                        <div class="col-md-2">
                            <label class="pull-right">@traducaoHelper["PAG"] @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) @traducaoHelper["DE"] @Model.PageCount &nbsp;</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-scrollable">
            <table class="table table-striped table-bordered table-hover">
                <thead>
                    <tr>
                        <th scope="col" style="min-width:80px; width:80px;">&nbsp;@traducaoHelper["ACOES"]&nbsp;</th>
                        <th scope="col">
                            @Html.ActionLink(traducaoHelper["LOGIN"], "Index", new { SortOrder = ViewBag.FirstSortParm, CurrentProcuraLogin = ViewBag.CurrentProcuraLogin, NumeroPaginas = ViewBag.CurrentNumeroPaginas, PageSize = ViewBag.PageSize })
                            @switch ((string)ViewBag.CurrentSort.ToString())
                            {
                                case "login":
                                    {<i class="fa fa-chevron-down"></i>}
                                    break;
                                case "login_desc":
                                    {<i class="fa fa-chevron-up"></i>}
                                    break;
                            }
                        </th>
                        <th scope="col">@traducaoHelper["CODIGO"]</th>
                        <th scope="col">@traducaoHelper["IDENTIFICADOR"]</th>
                        <th scope="col">@traducaoHelper["DATA"]</th>
                        <th scope="col">@traducaoHelper["MEIO_PAGAMENTO"]</th>
                        <th scope="col">@traducaoHelper["VALOR"] (@moedaPadrao.Simbolo)</th>
                        <th scope="col">@traducaoHelper["ADMINISTRADOR"]</th>
                        <th scope="col">@traducaoHelper["STATUS"]</th>
                        @*<th scope="col">@traducaoHelper["STATUS"] Entrega</th>*@
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th scope="col" style="min-width:80px; width:80px;">&nbsp;@traducaoHelper["ACOES"]&nbsp;</th>
                        <th scope="col">
                            @Html.ActionLink(traducaoHelper["LOGIN"], "Index", new { SortOrder = ViewBag.FirstSortParm, CurrentProcuraLogin = ViewBag.CurrentProcuraLogin, NumeroPaginas = ViewBag.CurrentNumeroPaginas, PageSize = ViewBag.PageSize })
                            @switch ((string)ViewBag.CurrentSort.ToString())
                            {
                                case "login":
                                    {<i class="fa fa-chevron-down"></i>}
                                    break;
                                case "login_desc":
                                    {<i class="fa fa-chevron-up"></i>}
                                    break;
                            }
                        </th>
                        <th scope="col">@traducaoHelper["CODIGO"]</th>
                        <th scope="col">@traducaoHelper["IDENTIFICADOR"]</th>
                        <th scope="col">@traducaoHelper["DATA"]</th>
                        <th scope="col">@traducaoHelper["MEIO_PAGAMENTO"]</th>
                        <th scope="col">@traducaoHelper["VALOR"] (@moedaPadrao.Simbolo)</th>
                        <th scope="col">@traducaoHelper["ADMINISTRADOR"]</th>
                        <th scope="col">@traducaoHelper["STATUS"]</th>
                        @*<th scope="col">@traducaoHelper["STATUS"] Entrega</th>*@
                    </tr>
                </tfoot>
                <tbody>
                    @foreach (var pedido in Model)
                    {
                        var label = "label-default";
                        switch (pedido.StatusAtual)
                        {
                            case Core.Entities.PedidoPagamentoStatus.TodosStatus.AguardandoConfirmacao:
                            case Core.Entities.PedidoPagamentoStatus.TodosStatus.AguardandoPagamento:
                                label = "label-warning";
                                break;
                            case Core.Entities.PedidoPagamentoStatus.TodosStatus.Cancelado:
                                label = "label-danger";
                                break;
                            case Core.Entities.PedidoPagamentoStatus.TodosStatus.Pago:
                                label = "label-success";
                                break;
                        }
                        var pagamento = pedido.PedidoPagamento.FirstOrDefault();
                        <tr>
                            <td>
                                @Html.ActionLink("Details", "Details", new { id = pedido.ID }, new { @class = "gridDetail", title = traducaoHelper["DETALHES"] })
                                @if (pedido.StatusAtual == Core.Entities.PedidoPagamentoStatus.TodosStatus.AguardandoPagamento)
                                {
                                    <a class="gridNovo" title="@traducaoHelper["OPCOES_APROVACAO"]" onclick="OpcoesAtivacao(@pedido.ID)"></a>
                                    <a class="gridDelete" title="@traducaoHelper["CANCELAR"]" onclick="ConfirmarCancelamento(@pedido.ID)"></a>
                                }
                                @if (pedido.StatusAtual == Core.Entities.PedidoPagamentoStatus.TodosStatus.Pago)
                                {
                                    @Html.ActionLink("Rastreamento", "Rastreamento", new { id = pedido.ID }, new { @class = "gridEdit", title = traducaoHelper["EDITAR"] })
                                }
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => pedido.Usuario.Login)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => pedido.ID)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => pedido.Codigo)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => pedido.DataCriacao)
                            </td>
                            <td class="text">@(pagamento != null ? pagamento.MeioPagamento.ToString() : "")</td>
                            <td class="text">@pedido.PedidoPagamento.Where(w => w.Valor.HasValue).Sum(s => s.Valor).Value.ToString(moedaPadrao.MascaraOut)</td>
                            <td class="text">
                                @{
                                    var pedidoPagamento = pedido.PedidoPagamento.FirstOrDefault();
                                    if (pedidoPagamento != null && pedidoPagamento.UltimoStatus.Administrador != null)
                                    {
                                        <span>@pedidoPagamento.UltimoStatus.Administrador.Nome</span>
                                    }
                                    else
                                    {
                                        <span>-</span>
                                    }
                                }
                            </td>
                            <td class="text">
                                <span class="label label-sm @label">
                                    @pedido.StatusAtual
                                </span>
                            </td>
                            @*<td class="text">
                                    @if (pedido.StatusAtual != Core.Entities.PedidoPagamentoStatus.TodosStatus.Cancelado)
                                    {
                                        <span class="label label-sm @label">
                                            @pedido.StatusEntregaAtual
                                        </span>
                                    }
                                </td>*@
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="row">
            <div class="border-gridFooter">
                <div class="col-md-10">
                    @Html.PagedListPager(Model, page => Url.Action("Index", new { page, SortOrder = ViewBag.CurrentSort, CurrentProcuraLogin = ViewBag.CurrentProcuraLogin, NumeroPaginas = ViewBag.CurrentNumeroPaginas, PageSize = ViewBag.PageSize }))
                </div>
                <div class="col-md-2">
                    <label class="pull-right">@traducaoHelper["PAG"]  @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) @traducaoHelper["DE"]  @Model.PageCount &nbsp;</label>
                </div>
            </div>
        </div>

        <div id="OpcoesAtivacao" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true" style="display: none; ">
            <div class="modal-dialog modal-sm" style="min-width: 380px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h4 class="modal-title">@traducaoHelper["CONFIRMACAO"]</h4>
                    </div>
                    <div class="modal-body">
                        <div class="conteudo">
                            <h5 class="help-block" style="padding: 0% 1.4% 0% 1.4%; text-align:justify;">@traducaoHelper["CONFIRMAR_PEDIDO"]</h5>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div class="row">
                            <div class="col-md-4"><button type="button" class="btn green" onclick="Gratuito()">@traducaoHelper["GRATUITO"]</button></div>
                            <div class="col-md-4"><button type="button" class="btn blue" onclick="Pagamento()">@traducaoHelper["APROVAR"]</button></div>
                            @*<div class="col-md-4"><button type="button" class="btn blue-dark" onclick="Lideranca()">@traducaoHelper["LIDERANCA"]</button></div>*@
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="Confirmacao" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true" style="display: none; ">
            <div class="modal-dialog modal-sm" style="min-width: 380px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h4 class="modal-title">@traducaoHelper["CONFIRMACAO"]</h4>
                    </div>
                    <div class="modal-body">
                        <div class="conteudo">
                            <h5 class="help-block" style="padding: 0% 1.4% 0% 1.4%; text-align:justify;">@traducaoHelper["CONFIRMAR_PEDIDO"]</h5>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn green" onclick="Pagamento()">@traducaoHelper["CONFIRMAR"]</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="ConfirmacaoGratuito" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true" style="display: none; ">
            <div class="modal-dialog modal-sm" style="min-width: 380px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h4 class="modal-title">@traducaoHelper["CONFIRMACAO"]</h4>
                    </div>
                    <div class="modal-body">
                        <div class="conteudo">
                            <h5 class="help-block" style="padding: 0% 1.4% 0% 1.4%; text-align:justify;">@traducaoHelper["CONFIRMAR_PEDIDO"]</h5>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn green" onclick="Gratuito()">@traducaoHelper["CONFIRMAR"]</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="Cancelamento" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true" style="display: none; ">
            <div class="modal-dialog modal-sm" style="min-width: 380px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h4 class="modal-title">@traducaoHelper["CONFIRMACAO"]</h4>
                    </div>
                    <div class="modal-body">
                        <div class="conteudo">
                            <h5 class="help-block" style="padding: 0% 1.4% 0% 1.4%; text-align:justify;">@traducaoHelper["CANCELAR_PEDIDO"]</h5>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn green" onclick="Cancelamento()">@traducaoHelper["CONFIRMAR"]</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
