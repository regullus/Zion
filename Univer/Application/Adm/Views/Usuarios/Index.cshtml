@model PagedList.IPagedList<Core.Entities.Usuario>
@using PagedList.Mvc;
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var traducaoHelper = (Core.Helpers.TraducaoHelper)ViewBag.TraducaoHelper;
    var associacoes = (IEnumerable<Core.Entities.Associacao>)ViewBag.Associacoes;
    var classificacoes = (IEnumerable<Core.Entities.Classificacao>)ViewBag.Classificacoes;
    var produtos = (IEnumerable<Core.Entities.Produto>)ViewBag.Produtos;
    var meioPagamentos = (IEnumerable<Core.Entities.MeioPagamento>)ViewBag.MeioPAgamento;
    var usuarioEntraOutraAba = ViewBag.UsuarioEntraOutraAba;
}
@section pageStyles {
    <link rel="stylesheet" href="~/Content/home/bootstrap.min.css">
    <link rel="stylesheet" href="~/Content/global/plugins/font-awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800">
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700,900" rel="stylesheet" />
    <link rel="stylesheet" href="~/Content/home/styles.css">
}
@section head {}
@section pageScripts {
    <script>
        $('.confirmarPagto').on('click', function () {
            var idUsuario = $(this).attr("data-id");
            var idBoard = $(this).attr("data-board");
            $('.titulo').html(idUsuario);

            Swal.fire({
                title: "@traducaoHelper["CONFIRMAR_PAGAMENTO"]",
                icon: 'warning',
                showDenyButton: true,
                showCancelButton: true,
                confirmButtonColor: '#1ba39c',
                denyButtonColor: '#d91e18',
                cancelButtonColor: '#555555',
                confirmButtonText: '@traducaoHelper["FOI_PAGO"]',
                cancelButtonText: '@traducaoHelper["CANCELAR"]',
                denyButtonText: '@traducaoHelper["NAO_FOI_PAGO"]'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                    url: "@Url.Action("FoiPago")",
                    type: "POST",
                    data: {
                        'usuarioID': idUsuario,
                        'BoardID': idBoard
                    },
                    success: function (data) {
                        if (data != null) {
                            if (data.toString() == "OK") {
                                location.reload();
                            } else {
                                Swal.fire({
                                    title: '@traducaoHelper["ALERTA"]',
                                    text: data.toString(),
                                    icon: 'warning',
                                    confirmButtonText: 'OK'
                                });
                            }
                        } else {
                            Swal.fire({
                                title: '@traducaoHelper["ALERTA"]: ' + xhr.status + '!',
                                text: '@traducaoHelper["SEM_DADOS"]',
                                icon: 'warning',
                                confirmButtonText: 'OK'
                            });
                        }
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        if (thrownError.toString() == '@traducaoHelper["TOKEN_INVALIDO"]') {
                            //Reload page
                            location.reload();
                        } else {
                            Swal.fire({
                                title: '@traducaoHelper["ERRO"]: ' + xhr.status + '!',
                                text: '@traducaoHelper["ERRO"]:' + thrownError.toString(),
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                        }
                    },
                    });
                } else if (result.isDenied) {
                    $.ajax({
                    url: "@Url.Action("NaoFoiPago")",
                    type: "POST",
                    data: {
                        'usuarioID': idUsuario,
                        'BoardID': idBoard
                    },
                    success: function (data) {
                        if (data != null) {
                            if (data.toString() == "OK") {
                                location.reload();
                            } else {
                                Swal.fire({
                                    title: '@traducaoHelper["ALERTA"]',
                                    text: data.toString(),
                                    icon: 'warning',
                                    confirmButtonText: 'OK'
                                });
                            }
                        } else {
                            Swal.fire({
                                title: '@traducaoHelper["ALERTA"]: ' + xhr.status + '!',
                                text: '@traducaoHelper["SEM_DADOS"]',
                                icon: 'warning',
                                confirmButtonText: 'OK'
                            });
                        }
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        if (thrownError.toString() == '@traducaoHelper["TOKEN_INVALIDO"]') {
                            //Reload page
                            location.reload();
                        } else {
                            Swal.fire({
                                title: '@traducaoHelper["ERRO"]: ' + xhr.status + '!',
                                text: '@traducaoHelper["ERRO"]:' + thrownError.toString(),
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                        }
                    },
                    });
                }
            });

        });

    </script>

    <script>
      $(".openAtivar").on("click", function () {
         var persistIDUsusario = $(this).data('id');
         $('#impIDUsuario').attr('value', persistIDUsusario);
      });

      $(".openAlterarSenha").on("click", function () {
         var id = $(this).data('id');
          $('#UsuarioIDAlterarSenha').attr('value', id);

          $("#NovaSenha").val('');
          $("#token2F").val('');

          $(".altera-senha-hide").show();
          $(".msg-altera-senha").text('');
          $("#modal-body-form").show();
          $("#modal-body-footer").show();
          $("#alterar-senha-loader").hide();

          $("#alterarSenha").modal('show');
      });

      $(".ConfirmarAlterarSenha").on("click", function () {

           var id = $('#UsuarioIDAlterarSenha').val();
           var senha = $("#NovaSenha").val();
           var token2F = $("#token2F").val();

           if (senha) {

                $("#alterar-senha-loader").show();
                $(".msg-altera-senha").text('');

               $.post('@Url.Action("AlterarSenha", "Usuarios")', { id: id, senha: senha, token2F: token2F }, function (data) {

                    $("#alterar-senha-loader").hide();

                   if (data.OK) {
                       $(".altera-senha-hide").hide();
                   }

                   $(".msg-altera-senha").text(data.msg);
               });

           }
       });

        $(".cbo").change(function () {
         var persistIDUsusario = $('#impIDUsuario').val();
         $('#impIDUsuario').attr('value', persistIDUsusario);
      });

      $('.ConfirmarAtivar').on('click', function () {
         var persistIDUsusario = $('#impIDUsuario').val();
         $('#impIDUsuario').attr('value', persistIDUsusario);

         swal({
            title: '@Html.Raw(traducaoHelper["TEM_CERTEZA"])',
            text: '@Html.Raw(traducaoHelper["DESEJA_ATIVAR_USUARIO"])',
            type: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '@Html.Raw(traducaoHelper["SIM"])',
            cancelButtonText: '@Html.Raw(traducaoHelper["NAO"])',
            closeOnConfirm: false,
            closeOnCancel: false
         },
         function (isConfirm) {
            if (isConfirm) {
               var skuProdutoAdesao = $("#cboProduto").val();
               var meioPagamento = $('#cboPagamento').val();
               var paraAvaliacao = 0;
               if ($('#paraAvaliacao').prop('checked')) {
                  paraAvaliacao = 1;
               };

               $.ajax({
                  url: '@Url.Action("Ativar")',
                  type: 'POST',
                  data: { 'UsuAtivarID': persistIDUsusario, 'skuProdutoAdesao': skuProdutoAdesao, 'meioPagamento': meioPagamento, 'paraAvaliacao': paraAvaliacao },
                  success: function (data) {
                     if (data == 'OK') {
                        $('[name=' + persistIDUsusario + ']').hide();
                        swal('@Html.Raw(traducaoHelper["SUCESSO"])', '@Html.Raw(traducaoHelper["USUARIO_ATIVADO_SUCESSO"])', 'success');
                     }
                     else {
                        swal('@Html.Raw(traducaoHelper["ERRO"])', data, 'error');
                     }
                  },
                  error: function (data) {
                     swal('@Html.Raw(traducaoHelper["ERRO"])', data, 'error');
                  }
               });

            } else {
               swal('@Html.Raw(traducaoHelper["CANCELADO"])', '@Html.Raw(traducaoHelper["SOLICITACAO_CANCELADA"])', 'error');
            };
         });

      });

      function Logar(usuarioID) {
         $.post('@Url.Action("Logar", "Usuarios")', { id: usuarioID }, function (data) {
            if (data != 'Index') {
               window.open(data);
            }
            else{
               Redirect(data);
            }
         });
      }

    </script>
}

@section PageLevelScripts{
    <script type="text/javascript" src="~/Content/scripts/jquery.min.js"></script>
    <script type="text/javascript" src="~/Content/scripts/bootstrap.min.js"></script>
    <script type="text/javascript" src="~/Content/scripts/countUp.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/Content/global/plugins/jquery.pulsate.min.js" type="text/javascript"></script>
    <script src="~/Content/global/plugins/jquery-bootpag/jquery.bootpag.min.js" type="text/javascript"></script>
    <script src="~/Content/pages/scripts/ui-general.min.js" type="text/javascript"></script>
}

@section jQueryRead {}

<div class="portlet box grey-gallery">
    <div class="portlet-title">
        <div class="caption"><i class="fa fa-reorder"></i> @traducaoHelper["USUARIOS"]</div>
        <div class="tools">
            <a href="javascript:;" class="collapse" title="@traducaoHelper["FECHAR"]" />
            <a href='@Url.Action("Reload", "Usuarios")' class="atualizar" title="@traducaoHelper["RELER"]" />
        </div>
        <div class="actions">
            <a href='@Url.Action("Excel", "Usuarios", new { CurrentProcuraLogin = ViewBag.CurrentProcuraLogin, CurrentProcuraPatrocinador = ViewBag.CurrentProcuraPatrocinador} )' class="btn btn-sm yellow-casablanca">
                <i class="fa fa-file-excel-o"></i> Excel
            </a>
            <a href='@Url.Action("InformePagamento", "Usuarios", new { CurrentProcuraLogin = ViewBag.CurrentProcuraLogin, CurrentProcuraPatrocinador = ViewBag.CurrentProcuraPatrocinador} )' class="btn btn-sm purple-soft">
                <i class="fa fa-money"></i> @traducaoHelper["INFORME_PGTO"]
            </a>
            <label>&nbsp;</label>
        </div>
    </div>

    <div class="portlet-body">
        <div class="table-toolbar">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <div class="input-group">
                            @using (Html.BeginForm("Index", "Usuarios", FormMethod.Get))
                            {
                                @Html.DropDownList("NumeroPaginas", null, htmlAttributes: new { @class = "form-control input-small input-inline marginB05" })
                                <input class="btn purple form-control input-small input-inline fontPlaceHolderIcon" id="Atualizar" name="Atualizar" value="&#xf021; @traducaoHelper["ATUALIZAR"]" type="submit" />
                            }
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    @using (Html.BeginForm("Index", "Usuarios", FormMethod.Get))
                    {
                        <div class="form-group pull-right">
                            <div class="input-group">
                                @Html.TextBox("ProcuraLogin", ViewBag.CurrentProcuraLogin as string, new { @class = "form-control input-small input-inline fontPlaceHolderIcon marginB05", @placeholder = traducaoHelper["LOGIN_NOME_EMAIL"] })
                                @Html.TextBox("ProcuraPatrocinador", ViewBag.CurrentProcuraPatrocinador as string, new { @class = "form-control input-small input-inline fontPlaceHolderIcon marginB05", @placeholder = traducaoHelper["PATROCINADOR"] })
                                <input class="btn blue-madison form-control input-small input-inline fontPlaceHolderIcon" id="Procura" name="Procura" value="&#xf002; @traducaoHelper["PROCURAR"]" type="submit" />
                            </div>
                        </div>
                    }
                </div>
            </div>
            <div class="row">
                <div class="col-md-10">
                    @Html.PagedListPager(Model, page => Url.Action("Index", new { page, SortOrder = ViewBag.CurrentSort, CurrentProcuraLogin = ViewBag.CurrentProcuraLogin, CurrentProcuraPatrocinador = ViewBag.CurrentProcuraPatrocinador, NumeroPaginas = ViewBag.CurrentNumeroPaginas, PageSize = ViewBag.PageSize }))
                </div>
                <div class="col-md-2">
                    <label class="pull-right">@traducaoHelper["PAG"] @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) @traducaoHelper["DE"] @Model.PageCount &nbsp;</label>
                </div>
            </div>
        </div>

        <div class="table-scrollable">
            <table class="table table-striped table-bordered table-hover">
                <thead>
                    <tr>
                        <th scope="col" style="min-width:95px; width:95px;">&nbsp;@traducaoHelper["ACOES"]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
                        <th scope="col">
                            @Html.ActionLink(traducaoHelper["LOGIN"], "Index", new { SortOrder = ViewBag.FirstSortParm, CurrentProcuraLogin = ViewBag.CurrentProcuraLogin, CurrentProcuraPatrocinador = ViewBag.CurrentProcuraPatrocinador, NumeroPaginas = ViewBag.CurrentNumeroPaginas, PageSize = ViewBag.PageSize })
                            @switch ((string)ViewBag.CurrentSort.ToString())
                            {
                                case "login":
                                    {<i class="fa fa-chevron-down"></i>}
                                    break;
                                case "login_desc":
                                    {<i class="fa fa-chevron-up"></i>}
                                    break;
                            }
                        </th>
                        <th scope="col">@traducaoHelper["NOME"]</th>
                        <th scope="col">@traducaoHelper["EMAIL"]</th>
                        <th scope="col">
                            @Html.ActionLink(@traducaoHelper["PATROCINADOR"], "Index", new { SortOrder = ViewBag.FirstSortParm, CurrentProcuraLogin = ViewBag.CurrentProcuraLogin, CurrentProcuraPatrocinador = ViewBag.CurrentProcuraPatrocinador, NumeroPaginas = ViewBag.CurrentNumeroPaginas, PageSize = ViewBag.PageSize })
                            @switch ((string)ViewBag.CurrentSort.ToString())
                            {
                                case "patrocinador":
                                    {<i class="fa fa-chevron-down"></i>}
                                    break;
                                case "patrocinador_desc":
                                    {<i class="fa fa-chevron-up"></i>}
                                    break;
                            }
                        </th>
                        <th scope="col">@traducaoHelper["STATUS"]</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th scope="col" style="min-width:80px; width:80px;">&nbsp;@traducaoHelper["ACOES"]&nbsp;</th>
                        <th scope="col">
                            @Html.ActionLink(traducaoHelper["LOGIN"], "Index", new { SortOrder = ViewBag.FirstSortParm, CurrentProcuraLogin = ViewBag.CurrentProcuraLogin, CurrentProcuraPatrocinador = ViewBag.CurrentProcuraPatrocinador, NumeroPaginas = ViewBag.CurrentNumeroPaginas, PageSize = ViewBag.PageSize })
                            @switch ((string)ViewBag.CurrentSort.ToString())
                            {
                                case "login":
                                    {<i class="fa fa-chevron-down"></i>}
                                    break;
                                case "login_desc":
                                    {<i class="fa fa-chevron-up"></i>}
                                    break;
                            }
                        </th>
                        <th scope="col">@traducaoHelper["NOME"]</th>
                        <th scope="col">@traducaoHelper["EMAIL"]</th>
                        <th scope="col">
                            @Html.ActionLink(@traducaoHelper["PATROCINADOR"], "Index", new { SortOrder = ViewBag.FirstSortParm, CurrentProcuraLogin = ViewBag.CurrentProcuraLogin, CurrentProcuraPatrocinador = ViewBag.CurrentProcuraPatrocinador, NumeroPaginas = ViewBag.CurrentNumeroPaginas, PageSize = ViewBag.PageSize })
                            @switch ((string)ViewBag.CurrentSort.ToString())
                            {
                                case "patrocinador":
                                    {<i class="fa fa-chevron-down"></i>}
                                    break;
                                case "patrocinador_desc":
                                    {<i class="fa fa-chevron-up"></i>}
                                    break;
                            }
                        </th>
                        <th scope="col">@traducaoHelper["STATUS"]</th>
                    </tr>
                </tfoot>
                <tbody>
                    @foreach (var item in Model)
                    {
                        var associacao = associacoes.FirstOrDefault(a => a.Nivel == item.NivelAssociacao);
                        var classificacao = classificacoes.FirstOrDefault(c => c.Nivel == item.NivelClassificacao);
                        <tr>
                            <td>
                                @Html.ActionLink("Edit", "Edit", new { id = item.ID }, new { @class = "gridEdit", title = traducaoHelper["EDITAR"] })
                                @Html.ActionLink("Details", "Details", new { id = item.ID }, new { @class = "gridDetail", title = traducaoHelper["DETALHES"] })
                                @if (User.IsInRole("perfilMaster") || User.IsInRole("perfilAdministrador"))
                                {
                                    if (usuarioEntraOutraAba)
                                    {
                                        @Html.ActionLink("Entrar", "Entrar", new { id = item.ID }, new { target = "_blank", @class = "gridTrocar", title = traducaoHelper["ENTRAR_COM_LOGIN_USUARIO"] + item.Nome })
                                    }
                                    else
                                    {
                                        @Html.ActionLink("Entrar", "Entrar", new { id = item.ID }, new { @class = "gridTrocar", title = traducaoHelper["ENTRAR_COM_LOGIN_USUARIO"] + item.Nome })
                                    }

                                    if (Core.Helpers.ConfiguracaoHelper.GetBoolean("ADM_TROCA_SENHA_RESETAR"))
                                    {
                                        @Html.ActionLink("Senha", "Senha", new { id = item.ID }, new { @class = "gridLock", title = traducaoHelper["TROCAR_ENVIAR_SENHA"] })
                                    }
                                    else
                                    {
                                        <a class="gridLock openAlterarSenha" name="@item.ID" id="@item.ID" data-id="@item.ID" data-toggle="modal" title=@traducaoHelper["ALTERAR_SENHA"] href="#altearSenha">@traducaoHelper["ALTERAR_SENHA"] </a>
                                    }
                                }
                                @if (item.Autenticacao.TwoFactorEnabled) //Verifica se usuario possui autenticação dois fatores
                                {
                                    @Html.ActionLink("DesabilitaAutenticacao", "DesabilitaAutenticacao", new { id = item.ID }, new { @class = "gridAutenticacao", title = traducaoHelper["DESABILITA_GOOGLE_AUTH"] })
                                }
                                @if (item.Oculto)
                                {
                                    <a class="gridNovo confirmarPagto" data-id="@item.ID" data-board="@item.TipoID" title="@(traducaoHelper["CONFIRMAR_PAGAMENTO"] + " " + item.Nome)"> @traducaoHelper["CONFIRMAR_PAGAMENTO"]</a>
                                }
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.Login)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.Nome)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.Email)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.PatrocinadorDireto.Nome)
                            </td>
                            <td>
                                @if (item.Bloqueado)
                                {
                                    @traducaoHelper["BLOQUEADO"]
                                }
                                else
                                {
                                    @Html.DisplayFor(modelItem => item.Status)
                                }
                            </td>

                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="row">
            <div class="border-gridFooter">
                <div class="col-md-10">
                    @Html.PagedListPager(Model, page => Url.Action("Index", new { page, SortOrder = ViewBag.CurrentSort, CurrentProcuraLogin = ViewBag.CurrentProcuraLogin, CurrentProcuraPatrocinador = ViewBag.CurrentProcuraPatrocinador, NumeroPaginas = ViewBag.CurrentNumeroPaginas, PageSize = ViewBag.PageSize }))
                </div>
                <div class="col-md-2">
                    <label class="pull-right">@traducaoHelper["PAG"]  @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) @traducaoHelper["DE"]  @Model.PageCount &nbsp;</label>
                </div>
            </div>
        </div>

    </div>

</div>

<div id="ativar" class="modal fade openAtivar" tabindex="-1" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">

        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">@traducaoHelper["ATIVAR"]</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" name="impIDUsuario" id="impIDUsuario" />
                <div class="form-group">
                    <label>@traducaoHelper["PRODUTO"]</label>
                    <select class="form-control cbo" name="cboProduto" id="cboProduto">
                        @foreach (var produto in produtos)
                        {
                            <option value="@produto.SKU">@produto.Nome</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>@traducaoHelper["MEIO_PAGAMENTO"]</label>
                    <select class="form-control cbo" name="cboPagamento" id="cboPagamento">
                        @foreach (var meioPagamento in meioPagamentos)
                        {
                            <option value="@meioPagamento.ID">@meioPagamento.Descricao</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label></label>
                    <div class="mt-checkbox-list">
                        <label class="mt-checkbox">
                            @traducaoHelper["AVALIACAO"]
                            <input type="checkbox" value="0" name="paraAvaliacao" id="paraAvaliacao" class="cbo" />
                            <span></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" data-dismiss="modal" data-id="0" class="btn btn-circle btn-sm green-seagreen ConfirmarAtivar">@Html.Raw(traducaoHelper["ATIVAR"])</button>
            </div>
        </div>
    </div>
</div>

<div id="alterarSenha" class="modal fade" tabindex="-1" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">@traducaoHelper["ALTERAR_SENHA"]</h4>
            </div>
            <div class="modal-body">
                <label class="msg-altera-senha"></label>
            </div>
            <div id="modal-body-form" class="modal-body altera-senha-hide">
                <input type="hidden" name="UsuarioIDAlterarSenha" id="UsuarioIDAlterarSenha" />
                <div class="form-group">
                    <label>Digite a nova senha</label>
                    <input type="text" id="NovaSenha" class="form-control" name="Nova Senha" />
                    <label class="msg-altera-senha"></label>
                </div>
                @if (Core.Helpers.ConfiguracaoHelper.GetString("AUTENTICACAO_DOIS_FATORES") == "true")
                {
                    <div class="form-group">
                        <img src="~/Content/global/img/google-authenticator.jpg" width="20" style="margin-bottom: 3px; margin-right: 5px;" />Token Google Authenticator<br />
                        <input type="text" class="form-control" name="token2F" id="token2F">
                        <a id="validaToken2FADinheiro" style="display:none; color: red;"></a>
                    </div>
                }

            </div>
            <div id="modal-body-footer" class="modal-footer altera-senha-hide">
                <div class="row">
                    <div class="col-md-6">
                        <img src="~/Content/global/img/ajax-loading.gif" id="alterar-senha-loader" />
                    </div>
                    <div class="col-md-6">
                        <button type="button" data-id="0" class="btn btn-circle btn-sm green-seagreen ConfirmarAlterarSenha">@Html.Raw(traducaoHelper["ALTERAR"])</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>